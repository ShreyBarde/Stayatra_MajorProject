<% layout("/layouts/boilerplate") %>

<style>
    .listing-card {
        border: none !important;
        margin-bottom: 2rem;
    }

    .card-img-top {
        border-radius: 1rem;
        height: 20rem;
    }

    .card-body {
        padding: 0 !important;
    }

    .listing-link {
        text-decoration: none;
    }

    .card-img-overlay {
        opacity: 0;
    }

    .card-img-overlay:hover {
        opacity: 0.2;
        background-color: white;
    }

    .tax-info {
        display: none;
    }

    .card-text {
        font-weight: 400;
    }

    .alert {
        text-align: center;
        margin: 2rem auto;
        max-width: 600px;
    }
</style>

<div id="filters">
    <!-- Add your filter buttons here if needed -->
</div>

<body>
    <% 
        // Safely handle allListings - check for undefined, null, or non-array
        const listings = (allListings && Array.isArray(allListings)) ? allListings : [];
    %>
    
    <% if (listings.length === 0) { %>
        <div class="alert alert-warning mt-4">
            <h4>No listings found!</h4>
            <p>Try selecting a different category or check back later.</p>
        </div>
    <% } else { %>
        <div class="row row-cols-lg-5 row-cols-md-3 row-cols-sm-1 mt-3">
            <% for(let listing of listings){ %>
                <div class="card col listing-card" style="width: 18rem;">
                    <a href="/listings/<%= listing.id || listing._id %>" class="listing-link">

                    <% 
                        const fallbackImg = 'https://images.unsplash.com/photo-1521401830884-6c03c1c87ebb?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=60';
                        let imgSrc = fallbackImg;
                        
                        // Safely extract image URL
                        if (listing.image) {
                            if (typeof listing.image === 'string') {
                                imgSrc = listing.image;
                            } else if (listing.image.url) {
                                imgSrc = listing.image.url;
                            }
                        }
                        
                        // Convert Unsplash photo page to direct image URL
                        try {
                            if (imgSrc) {
                                const m = imgSrc.match(/unsplash\.com\/photos\/([A-Za-z0-9_-]+)/);
                                if (m) imgSrc = `https://source.unsplash.com/${m[1]}/800x600`;
                            }
                        } catch(e){}
                    %>
                    
                    <img src="<%= imgSrc %>" class="card-img-top" alt="<%= listing.title || 'listing image' %>" loading="lazy">
                    <div class="card-img-overlay"></div>
                    <div class="card-body">
                        <b><h5 class="card-title"><%= listing.title || 'Untitled' %></h5></b>
                        <p class="card-text">
                            Price: <%= (listing.price && (typeof listing.price === 'number' || !isNaN(Number(listing.price)))) ? new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(Number(listing.price)) : 'N/A' %> per night  
                            &nbsp; &nbsp;  
                            <i class="tax-info">+18% GST</i>
                        </p>
                    </div>
                    </a> 
                </div>
            <% } %>
        </div>
    <% } %>
</body>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const taxSwitch = document.getElementById('switchCheckDefault');
        
        if (taxSwitch) {
            taxSwitch.addEventListener('click', function() {
                const taxInfoElements = document.querySelectorAll('.tax-info');
                
                taxInfoElements.forEach(function(info) {
                    if (info.style.display !== 'inline') {
                        info.style.display = 'inline';
                    } else {
                        info.style.display = 'none';
                    }
                });
            });
        }
    });
</script>